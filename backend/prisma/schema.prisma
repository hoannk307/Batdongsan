// Prisma Schema cho Website Bất động sản
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

// Prisma seed configuration
// Chạy: npm run  :seed

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// BẢNG NGƯỜI DÙNG
// ============================================
model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique @db.VarChar(50)
  email     String   @unique @db.VarChar(100)
  password  String   @db.VarChar(255)
  fullName  String?  @map("full_name") @db.VarChar(100)
  phone     String?  @db.VarChar(20)
  role      UserRole @default(USER)
  avatar    String?  @db.VarChar(255)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  properties Property[]
  news       News[]
  favorites  Favorite[]

  @@map("users")
}

enum UserRole {
  USER
  ADMIN
}

// ============================================
// BẢNG BẤT ĐỘNG SẢN
// ============================================
model Property {
  id             Int             @id @default(autoincrement())
  userId         Int             @map("user_id")
  propertyType   String          @map("property_type") @db.VarChar(100)
  propertyStatus PropertyStatus  @map("property_status")
  beds           Int?            @default(0)
  baths          Int?            @default(0)
  area           Decimal         @db.Decimal(10, 2)
  price          Decimal         @db.Decimal(15, 2)
  description    String?         @db.Text
  anyCity        String          @map("any_city") @db.VarChar(100)
  anyWard        String          @map("any_ward") @db.VarChar(100)
  landmark       String?         @db.VarChar(255)
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")

  // Relations
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  images    PropertyImage[]
  favorites Favorite[]

  // Indexes for search optimization
  @@index([propertyStatus, createdAt])
  @@index([propertyType])
  @@index([anyCity])
  @@index([price])
  @@index([area])
  @@map("properties")
}

enum PropertyStatus {
  FOR_RENT
  FOR_SALE
}

// ============================================
// BẢNG HÌNH ẢNH BẤT ĐỘNG SẢN
// ============================================
model PropertyImage {
  id         Int      @id @default(autoincrement())
  propertyId Int      @map("property_id")
  imageUrl   String   @map("image_url") @db.VarChar(500)
  isPrimary Boolean  @default(false) @map("is_primary")
  order      Int      @default(0)
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@map("property_images")
}

// ============================================
// BẢNG TIN TỨC
// ============================================
model News {
  id           Int        @id @default(autoincrement())
  userId       Int        @map("user_id")
  title        String     @db.VarChar(255)
  slug         String     @unique @db.VarChar(255)
  summary      String?    @db.Text
  content      String     @db.Text
  featuredImage String?   @map("featured_image") @db.VarChar(500)
  category     String?    @db.VarChar(50)
  views        Int        @default(0)
  status       NewsStatus @default(DRAFT)
  publishedAt  DateTime?  @map("published_at")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status, publishedAt])
  @@index([category])
  @@index([slug])
  @@map("news")
}

enum NewsStatus {
  PUBLISHED  // Đã xuất bản
  DRAFT      // Nháp
}

// ============================================
// BẢNG ĐỊA ĐIỂM (Tỉnh/Phường)
// ============================================
model Location {
  id       Int          @id @default(autoincrement())
  code     String       @unique @db.VarChar(20)
  name     String       @db.VarChar(100)
  type     LocationType
  parentId Int?         @map("parent_id")
  level    Int          // 1=province, 2=ward

  // Self-referential relation
  parent   Location?    @relation("LocationHierarchy", fields: [parentId], references: [id])
  children Location[]   @relation("LocationHierarchy")

  @@index([type])
  @@index([parentId])
  @@index([level])
  @@map("locations")
}

enum LocationType {
  PROVINCE  // Tỉnh/Thành phố
  WARD      // Phường/Xã
}

// ============================================
// BẢNG YÊU THÍCH (Optional - Tính năng bổ sung)
// ============================================
model Favorite {
  id         Int      @id @default(autoincrement())
  userId     Int      @map("user_id")
  propertyId Int      @map("property_id")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([userId, propertyId])
  @@index([userId])
  @@map("favorites")
}

